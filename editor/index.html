<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Professional Image Editor</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @font-face {
          font-family: 'Mardoto-Light';
          src: url('../../fonts/Mardoto-Light.ttf') format('truetype');
          font-weight: 300;
          font-style: normal;
          font-display: swap;
        }
        body {
            margin: 0;
            background-color: #f0f0f0;
            font-family: 'Mardoto-Light', sans-serif;
            /* Leave room for the sidebar */
            padding-left: 220px;
        }
        /* Sidebar */
        .nav-links {
          position: fixed;
          left: 0;
          top: 0;
          height: 100%;
          width: 200px;
          background: #f5f5f5;
          padding: 2rem 1rem;
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }
        .nav-links a {
          text-decoration: none;
          font-size: 1rem;
          color: #000;
          padding: 0.8rem 1.2rem;
          border: 1px solid #000;
          border-radius: 8px;
          transition: all 0.3s;
        }
        .nav-links a.active {
          background: #000;
          color: white;
        }
        .nav-links a:hover {
          background: #000;
          color: white;
        }
        .logout-link {
          margin-top: auto;
          font-size: 0.9rem;
          color: #dc3545;
          text-decoration: none;
        }
        /* Fixed Controls at Top */
        .controls {
            position: fixed;
            top: 0;
            left: 220px;
            width: calc(100% - 220px);
            background-color: #f0f0f0;
            padding: 10px;
            text-align: center;
            z-index: 1000;
        }
        .controls input[type="file"],
        .controls button {
            margin: 0 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .controls button {
            background-color: #4CAF50;
            color: white;
        }
        #extendPage { background-color: #2196F3; }
        /* A4 Container */
        #a4-container {
            width: 8.27in;
            height: 11.69in;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin: 80px auto 20px auto; /* Increased top margin to avoid fixed toolbar */
            position: relative;
            overflow: hidden;
        }
        .resizable {
            position: absolute;
            cursor: move;
            transform-origin: top left;
            box-sizing: border-box;
        }
        .resizable img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
            /* Crisp image rendering */
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            image-rendering: pixelated;
        }
        .resize-handle {
            position: absolute;
            right: -8px;
            bottom: -8px;
            width: 16px;
            height: 16px;
            background-color: #4CAF50;
            border-radius: 50%;
            cursor: nwse-resize;
            z-index: 2;
        }
        .hide-handles .resize-handle { display: none !important; }
    </style>
</head>
<body>
    <!-- Navigation Sidebar -->
    <nav class="nav-links">
      <a href="https://pha.am/tutorcal">Հարցերի տվյալներ</a>
      <a href="https://pha.am/tutorcal/attendance">Հաճախություն</a>
      <a href="https://pha.am/editor" class="active">Դասի խմբագրիչ</a>
      <a href="#" class="logout-link" onclick="logout()">Դուրս գալ</a>
    </nav>
    
    <!-- Fixed Controls -->
    <div class="controls">
        <input type="file" id="imageUpload" accept="image/*">
        <button id="extendPage" onclick="extendPage()">Extend Page</button>
        <button onclick="saveAsPNG()">Save as PNG</button>
    </div>
    
    <div id="a4-container"></div>
    
    <!-- Firebase Authentication (for logout functionality) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        const firebaseConfig = {
          apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
          authDomain: "physmathacademy-722b3.firebaseapp.com",
          projectId: "physmathacademy-722b3",
          storageBucket: "physmathacademy-722b3.appspot.com",
          messagingSenderId: "1093649922622",
          appId: "1:1093649922622:web:35b1bf4d2364bcf745f587",
          measurementId: "G-CGVKXTXJLB"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "/login/"; });
        window.logout = async () => {
          try { 
              await signOut(auth); 
              window.location.href = "/login/"; 
          } catch (error) { 
              console.error("Logout error:", error); 
          }
        };
    </script>
    <script>
        let selectedElement = null;
        let isResizing = false;
        const MIN_SIZE = 50;
        let offsetX = 0, offsetY = 0, startX = 0, startY = 0, startWidth = 0, startHeight = 0;
        function getClientX(e) { return e.touches ? e.touches[0].clientX : e.clientX; }
        function getClientY(e) { return e.touches ? e.touches[0].clientY : e.clientY; }
        
        // When an image is uploaded, place it relative to the user's current viewport
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const container = document.createElement('div');
                container.className = 'resizable';
                const img = new Image();
                const a4Container = document.getElementById('a4-container');
                img.onload = function() {
                    const aspect = img.naturalWidth / img.naturalHeight;
                    container.dataset.aspect = aspect;
                    // Set default dimensions without squeezing the image
                    const imgWidth = 200;
                    const imgHeight = 200 / aspect;
                    // Calculate position based on the current viewport center relative to the A4 container
                    const containerRect = a4Container.getBoundingClientRect();
                    const viewportCenterX = window.innerWidth / 2;
                    const viewportCenterY = window.innerHeight / 2;
                    const posX = viewportCenterX - containerRect.left - (imgWidth / 2);
                    const posY = viewportCenterY - containerRect.top - (imgHeight / 2);
                    container.style.width = imgWidth + 'px';
                    container.style.height = imgHeight + 'px';
                    container.style.left = posX + 'px';
                    container.style.top = posY + 'px';
                };
                img.src = event.target.result;
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                container.appendChild(img);
                container.appendChild(resizeHandle);
                container.addEventListener('mousedown', startDragging);
                container.addEventListener('touchstart', startDragging, {passive: false});
                resizeHandle.addEventListener('mousedown', startResizing);
                resizeHandle.addEventListener('touchstart', startResizing, {passive: false});
                a4Container.appendChild(container);
            };
            reader.readAsDataURL(file);
        });
        
        // Extend the A4 container's height by one A4 page (11.69in * 96px/in)
        function extendPage() {
            const container = document.getElementById('a4-container');
            container.style.height = (container.offsetHeight + 11.69 * 96) + "px";
        }
        
        // Ensure new dimensions remain within the container bounds
        function enforceBoundaries(element, newWidth, newHeight) {
            const container = document.getElementById('a4-container');
            const maxX = container.offsetWidth - element.offsetLeft;
            const maxY = container.offsetHeight - element.offsetTop;
            return {
                width: Math.max(MIN_SIZE, Math.min(newWidth, maxX)),
                height: Math.max(MIN_SIZE, Math.min(newHeight, maxY))
            };
        }
        
        // Save the A4 container as a PNG with high quality yet reasonable file size.
        async function saveAsPNG() {
            const container = document.getElementById('a4-container');
            container.classList.add('hide-handles');
            // Remove box-shadow temporarily to avoid a black rectangle in the export
            const originalBoxShadow = container.style.boxShadow;
            container.style.boxShadow = "none";
            // Use a scale factor based on devicePixelRatio, but cap it at 2 for reasonable weight.
            const scaleFactor = Math.min(window.devicePixelRatio || 1, 2);
            await html2canvas(container, {
                scale: scaleFactor,
                useCORS: true,
                backgroundColor: '#FFFFFF'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'document.png';
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                // Restore original styling after export
                container.style.boxShadow = originalBoxShadow;
                container.classList.remove('hide-handles');
            });
        }
        
        // Drag functionality for moving uploaded elements
        function startDragging(e) {
            if (isResizing) return;
            selectedElement = e.currentTarget;
            const rect = selectedElement.getBoundingClientRect();
            if (e.touches) e.preventDefault();
            offsetX = getClientX(e) - rect.left;
            offsetY = getClientY(e) - rect.top;
            if (e.type === 'touchstart') {
                document.addEventListener('touchmove', dragElement, {passive: false});
                document.addEventListener('touchend', stopDragging);
            } else {
                document.addEventListener('mousemove', dragElement);
                document.addEventListener('mouseup', stopDragging);
            }
        }
        
        function dragElement(e) {
            if (!selectedElement || isResizing) return;
            if (e.touches) e.preventDefault();
            const container = document.getElementById('a4-container');
            const containerRect = container.getBoundingClientRect();
            let newX = getClientX(e) - containerRect.left - offsetX;
            let newY = getClientY(e) - containerRect.top - offsetY;
            newX = Math.max(0, Math.min(newX, container.offsetWidth - selectedElement.offsetWidth));
            newY = Math.max(0, Math.min(newY, container.offsetHeight - selectedElement.offsetHeight));
            selectedElement.style.left = newX + 'px';
            selectedElement.style.top = newY + 'px';
        }
        
        function stopDragging() {
            selectedElement = null;
            document.removeEventListener('mousemove', dragElement);
            document.removeEventListener('mouseup', stopDragging);
            document.removeEventListener('touchmove', dragElement);
            document.removeEventListener('touchend', stopDragging);
        }
        
        // Resizing functionality for the uploaded images
        function startResizing(e) {
            e.stopPropagation();
            isResizing = true;
            selectedElement = e.currentTarget.parentElement;
            const rect = selectedElement.getBoundingClientRect();
            if (e.touches) e.preventDefault();
            startX = getClientX(e);
            startY = getClientY(e);
            startWidth = rect.width;
            startHeight = rect.height;
            if (e.type === 'touchstart') {
                document.addEventListener('touchmove', resizeElement, {passive: false});
                document.addEventListener('touchend', stopResizing);
            } else {
                document.addEventListener('mousemove', resizeElement);
                document.addEventListener('mouseup', stopResizing);
            }
        }
        
        function resizeElement(e) {
            if (!isResizing || !selectedElement) return;
            if (e.touches) e.preventDefault();
            const aspect = parseFloat(selectedElement.dataset.aspect);
            const deltaX = getClientX(e) - startX;
            const deltaY = getClientY(e) - startY;
            let newWidth = startWidth + deltaX;
            let newHeight = startHeight + deltaY;
            // Maintain the original aspect ratio without squeezing the image
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                newHeight = newWidth / aspect;
            } else {
                newWidth = newHeight * aspect;
            }
            const constrained = enforceBoundaries(selectedElement, newWidth, newHeight);
            selectedElement.style.width = constrained.width + 'px';
            selectedElement.style.height = constrained.height + 'px';
        }
        
        function stopResizing() {
            isResizing = false;
            selectedElement = null;
            document.removeEventListener('mousemove', resizeElement);
            document.removeEventListener('mouseup', stopResizing);
            document.removeEventListener('touchmove', resizeElement);
            document.removeEventListener('touchend', stopResizing);
        }
    </script>
</body>
</html>
