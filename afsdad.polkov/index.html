<!DOCTYPE html>
<html lang="hy">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" type="image/jpg" href="https://pha.am/rounded_favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="stylesheet" href="/thestyle.css">
    <link rel="manifest" href="/manifest.json">

    <!-- Authentication -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
            authDomain: "physmathacademy-722b3.firebaseapp.com",
            projectId: "physmathacademy-722b3",
            storageBucket: "physmathacademy-722b3.appspot.com",
            messagingSenderId: "1093649922622",
            appId: "1:1093649922622:web:35b1bf4d2364bcf745f587",
            measurementId: "G-CGVKXTXJLB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let userName = "";

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "/login/"; // Redirect if not logged in
                return;
            }

            const userEmail = user.email.toLowerCase();
            const emailParts = userEmail.split("@")[0].split("."); // Splits first.last
            userName = emailParts.map(name => name.charAt(0).toUpperCase() + name.slice(1)).join(" "); // Capitalizes first letters

            // Get the current page path (e.g., '/afsdad.polkov/')
            const currentPath = window.location.pathname.replace(/\//g, "").toLowerCase();

            if (userEmail.split("@")[0] !== currentPath) {
                window.location.href = "/login/"; // Redirect if accessing another user's page
            }
        });

        window.logout = async () => {
            try {
                await signOut(auth);
                window.location.href = "/login/";
            } catch (error) {
                console.error("Logout error:", error);
            }
        };

        // Function to join the Jitsi meeting with the user's name
        function joinMeeting() {
            const domain = "meet.jit.si";
            const options = {
                roomName: "PhA-Math-Class",
                width: "100%",
                height: "100%",
                parentNode: document.querySelector("#meetingContainer"),
                userInfo: {
                    displayName: userName
                }
            };
            const api = new JitsiMeetExternalAPI(domain, options);
        }
    </script>
</head>
<body>
    <div class="container">
        <img src="https://pha.am/logo.png" alt="PhA Logo" class="profile-image">
        
        <div class="id-container">
            <h2>511639</h2>
            <img src="https://pha.am/cloud.png" alt="Install App" class="install-icon" id="installIcon">
        </div>

        <p class="description">Բարի գալուստ, <span id="userNameDisplay">User</span></p>

        <a class="buttonO" href="https://pha.am/homework/">Թեստային աշխատանք</a>
        <button class="button" onclick="joinMeeting()">Միանալ դասին</button>
        <a class="button" href="https://calendar.google.com/calendar/">Հաճախություն</a>
        <a class="button" href="#" onclick="checkSubscription()">Բաժանորդագրություն</a>
        <a class="button" href="https://invite.viber.com/">Համայնք</a>
        <button class="button" onclick="logout()" style="background: #dc3545;">Դուրս գալ</button>
    </div>

    <div id="meetingContainer" style="width: 100%; height: 100vh;"></div>

    <script>
        let deferredPrompt;

        window.addEventListener("beforeinstallprompt", (event) => {
            event.preventDefault();
            deferredPrompt = event;
            document.getElementById("installIcon").style.display = "inline";
        });

        document.getElementById("installIcon").addEventListener("click", () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                });
            }
        });

        function checkSubscription() {
            alert('Ձեր բաժանորդագրությունը ԱԿՏԻՎ է մինչև 01.03.2025');
        }
    </script>
</body>
</html>
